define(["jquery","google","oauthSignature","./tokens","mapIcons","./view-model"],function(a,b,c,d,e,f){"use strict";function g(a,b,c,d,e,f,g,h,i,j,k,l){this.latLng={lat:a,lng:b},this.name=c,this.suburb=d,this.address=e,this.image=f,this.description=g,this.open_now=h,this.phone=i,this.fourSquareUrl=j,this.yelpSnippet=k,this.yelpUrl=l}function h(a){H.hasOwnProperty(a.address.toLowerCase())?H[a.address.toLowerCase()].mergePlace(a):H[a.address.toLowerCase()]=a}function i(){f.places([]);for(var a in H)H.hasOwnProperty(a)&&f.places.push(H[a])}function j(){a(".hasclear").keyup(function(){var b=a(this);b.next("span").toggle(Boolean(b.val()))}),a(".clearer").hide(a(this).prev("input").val()),a(".clearer").click(function(){f.searchTextFilter(""),a(this).prev("input").focus(),a(this).hide()})}function k(a,b){localStorage.setItem("neigborhoodMapCenterCoords",JSON.stringify(a)),localStorage.setItem("neigborhoodMapCenterName",b)}function l(){return localStorage.hasOwnProperty("neigborhoodMapCenterCoords")?JSON.parse(localStorage.neigborhoodMapCenterCoords):E}function m(){return localStorage.neigborhoodMapCenterName||F}function n(){var a=l(),c=m();f.searchLocation(c),"fail"!=b.load?(G=new b.maps.Map(document.getElementById("map"),{center:a,scrollwheel:!0,zoom:14,mapTypeId:b.maps.MapTypeId.TERRAIN}),f.googleFail(!1)):f.googleFail(!0)}function o(){if("fail"!=b.load){var c=a("#location-input")[0],d=new b.maps.places.Autocomplete(c,{types:["(regions)"]});d.addListener("place_changed",function(){var a=d.getPlace();I(a),f.locationInput("")})}}function p(){f.places().forEach(function(a){a.hasOwnProperty("infoWindow")&&(a.infoWindow.close(),a.marker.clearHighlight())})}function q(){"fail"!==b.load&&new b.maps.places.PlacesService(G).nearbySearch({location:new b.maps.LatLng(l().lat,l().lng),radius:3e3,type:"bicycle_store"},r)}function r(a,c){c==b.maps.places.PlacesServiceStatus.OK?a.forEach(function(a){var b=s(a);b.createMarker(),b.addInfoWindow(),h(b)}):f.googleFail(!0),i()}function s(a){var b,c=a.geometry.location.lat(),d=a.geometry.location.lng(),e=a.name;b=-1!==a.vicinity.indexOf(",")?C(a.vicinity.split(",")[1].trim()):a.vicinity;var f,h=B(a.vicinity.split(",")[0].trim())+", "+b;a.hasOwnProperty("photos")&&a.photos.length>0&&(f=a.photos[0].getUrl({maxWidth:100,maxHeight:100}));var i,j=a.types[0].replace("_"," ");return a.hasOwnProperty("opening_hours")&&(i=a.opening_hours.open_now),new g(c,d,e,b,h,f,j,i,null,null,null,null)}function t(){var b=a.ajax("https://api.foursquare.com/v2/venues/search",{dataType:"json",data:{client_id:d.fourSquareTokens.clientId,client_secret:d.fourSquareTokens.clientSecret,ll:l().lat.toString()+","+l().lng.toString(),query:"bicycle",v:20160310}});b.done(u),b.fail(v)}function u(a){a.response.venues.forEach(function(a){if(a.location.hasOwnProperty("address")&&a.location.hasOwnProperty("city")){var b=w(a);b.createMarker(),b.addInfoWindow(b),h(b)}}),i(),f.fourSqrFail(!1)}function v(){console.log("Foursquare ajax failed"),f.fourSqrFail(!0)}function w(a){var b,c=a.location.lat,e=a.location.lng,f=a.name,h=C(a.location.city.split(",")[0].trim()),i=B(a.location.address)+", "+h;a.hasOwnProperty("contact")&&a.contact.hasOwnProperty("formattedPhone")&&(b=a.contact.formattedPhone);var j;if(a.categories.length>0&&(j=a.categories[0].name,a.categories.length>1)){for(var k=1;k>a.categories.length-1;k++)j+=", "+a.categories[k];j+=" and "+a.categories[a.categories.length-1]}var l="https://foursquare.com/v/"+a.id+"?ref="+d.fourSquareTokens.clientId;return new g(c,e,f,h,i,null,j,null,b,l,null,null)}function x(){var b="https://api.yelp.com/v2/search",e={oauth_consumer_key:d.yelpTokens.consumerKey,oauth_token:d.yelpTokens.token,oauth_nonce:Math.floor(1e12*Math.random()).toString(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",term:"bicycle_store",cll:l().lat.toString()+","+l().lng.toString(),location:m(),callback:"cb"};e.oauth_signature=c.generate("GET",b,e,d.yelpTokens.consumerSecret,d.yelpTokens.tokenSecret);var f=a.ajax({url:b,data:e,cache:!0,dataType:"jsonp"});f.done(y),f.fail(z)}function y(a){a.businesses.forEach(function(a){if(a.location.hasOwnProperty("address")&&a.location.address.length>0){var b=A(a);b.createMarker(),b.addInfoWindow(),h(b)}}),i(),f.yelpFail(!1)}function z(){console.log("yelp ajax failed"),f.yelpFail(!0)}function A(a){var b,c=a.location.coordinate.latitude,d=a.location.coordinate.longitude,e=a.name,f=C(a.location.city),h=B(a.location.address[0])+", "+f;a.hasOwnProperty("image_url")&&(b=a.image_url);var i;if(a.hasOwnProperty("catagories")&&a.categories.length>0&&(i=a.categories[0][0],a.categories.length>1)){for(var j=1;j>a.categories.length-1;j++)i+=", "+a.categories[j][0];i+=" and "+a.categories[a.categories.length-1]}var k,l=a.phone;a.hasOwnProperty("snippet_text")&&(k=a.snippet_text);var m=a.url;return new g(c,d,e,f,h,b,i,null,l,null,k,m)}function B(a){return a=a.replace(".",""),a=a.replace(/St$/,"Street"),a=a.replace(/Rd$/,"Road")}function C(a){return a=a.replace(".",""),a=a.replace("St","Saint")}var D={},E={lat:-37.8647,lng:144.9696},F="St Kilda, Australia",G={},H={};g.prototype.createMarker=function(){"fail"!=e.load&&(this.marker=new e.Marker({position:this.latLng,map:G,icon:{path:e.MAP_PIN,fillColor:"darkslategrey",fillOpacity:.8,strokeColor:"",strokeWeight:0},map_icon_label:'<span class="map-icon map-icon-bicycle-store"></span>'}))},g.prototype.addInfoWindow=function(){if("fail"!=e.load){this.infoWindow=new b.maps.InfoWindow,this.updateInfoWindowContent();var a=this;this.marker.addListener("click",function(){a.toggle()}),this.infoWindow.addListener("closeclick",function(){a.marker.clearHighlight()})}},g.prototype.open=function(){p(),this.hasOwnProperty("marker")&&(this.infoWindow.open(G,this.marker),this.marker.setIcon(),this.marker.setHighlight())},g.prototype.close=function(){this.infoWindow.close(),this.marker.clearHighlight()},g.prototype.toggle=function(){this.infoWindow.map?this.close():this.open()},g.prototype.updateInfoWindowContent=function(){var b=a('<div class="info-window-content"></div>')[0];a("<h3>"+this.name+"</h3>").appendTo(b),this.description&&a('<h4 class="info-window-place-description">'+this.description+"</h4>").appendTo(b);var c=a('<div class="info-window-body"></div>').appendTo(b),d=a('<div class="info-window-body-text"></div>').appendTo(c);a("<h5>"+this.address+"</h5>").appendTo(d),this.phone&&a("<p>"+this.phone+"</p>").appendTo(d),this.fourSquareUrl&&a("<p><a href="+this.fourSquareUrl+'><img src="images/Connect-to-Foursquare-150.png"></a></p>').appendTo(d),this.yelpUrl&&a("<p><a href="+this.yelpUrl+'><img src="images/yelp_review_btn_dark.png"></a></p>').appendTo(d),null!==this.open_now&&(this.open_now?a("<p>Now Open!</p>").appendTo(d):a("<p>Currently Closed</p>").appendTo(d)),this.yelpSnippet&&a('<p>"'+this.yelpSnippet+'"</p>').appendTo(d),this.image&&a('<div class="info-window-image-container"><img class="info-window-image" src='+this.image+"></div>").appendTo(c),this.infoWindow.setContent(b)},g.prototype.mergePlace=function(a){for(var b in this)this.hasOwnProperty(b)&&(null!==a[b]&&null===this[b]&&(this[b]=a[b]),this.hasOwnProperty("infoWindow")&&this.updateInfoWindowContent(this),a.hasOwnProperty("marker")&&a.marker.setMap(null))},g.prototype.longName=function(){return this.suburb?this.name+", "+this.suburb:this.name};var I=(D.init=function(){j(),n(),o(),q(),t(),x()},D.updateLocation=function(a){var b=a.geometry.location.lat(),c=a.geometry.location.lng(),d=a.formatted_address;k({lat:b,lng:c},d),f.searchLocation(m()),f.suburbFilter(""),f.searchTextFilter(""),G.panTo({lat:b,lng:c});for(var e in H)H.hasOwnProperty(e)&&(H[e].marker.setMap(null),delete H[e].infoWindow);H={},q(),t(),x()});return e.Marker.prototype.show=function(){this.setMap(G)},e.Marker.prototype.hide=function(){this.setMap(null)},e.Marker.prototype.setHighlight=function(){this.setIcon({path:e.MAP_PIN,fillColor:"midnightblue",fillOpacity:.8,strokeColor:"",strokeWeight:0})},e.Marker.prototype.clearHighlight=function(){this.setIcon({path:e.MAP_PIN,fillColor:"darkslategrey",fillOpacity:.8,strokeColor:"",strokeWeight:0})},D});